<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Quiz</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f8f9fa;
    }
    .question {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .choices button {
      display: block;
      width: 100%;
      padding: 1rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    .choices button:hover {
      background-color: #0056b3;
    }
    .message {
      margin-top: 1.5rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="question" id="question">Chargement de la question...</div>
  <div class="choices" id="choices"></div>
  <div class="message" id="message"></div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/TON_ID_SCRIPT/exec";

    let currentQuestionId = "";

    async function loadQuestion() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getQuestion`);
        const data = await res.json();

        currentQuestionId = data.id;
        if (!currentQuestionId) {
          document.getElementById("question").textContent = data.question || "Aucune question active.";
          return;
        }

        document.getElementById("question").textContent = data.question;
        const choicesDiv = document.getElementById("choices");
        choicesDiv.innerHTML = "";

        data.choices.forEach(choice => {
          const btn = document.createElement("button");
          btn.textContent = choice;
          btn.onclick = () => submitAnswer(choice);
          choicesDiv.appendChild(btn);
        });

        // Si déjà répondu, on désactive les choix
        const answeredKey = `answered_${currentQuestionId}`;
        if (localStorage.getItem(answeredKey)) {
          disableChoices("Vous avez déjà répondu à cette question.");
        }

      } catch (err) {
        console.error("Erreur lors du chargement :", err);
        document.getElementById("question").textContent = "Erreur de chargement.";
      }
    }

    async function submitAnswer(choice) {
      const answeredKey = `answered_${currentQuestionId}`;
      if (localStorage.getItem(answeredKey)) {
        document.getElementById("message").textContent = "Vous avez déjà répondu.";
        return;
      }

      try {
        const params = new URLSearchParams({
          action: "submitAnswer",
          questionId: currentQuestionId,
          choice: choice,
          userAgent: navigator.userAgent
        });

        const res = await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: "POST" });
        const data = await res.json();

        if (data.message === "Réponse enregistrée") {
          localStorage.setItem(answeredKey, "true");
          disableChoices("Merci pour votre réponse !");
        } else {
          throw new Error(data.error || "Réponse inconnue du serveur.");
        }

      } catch (err) {
        console.error("Erreur lors de la soumission :", err);
        document.getElementById("message").textContent = "Erreur : " + err.message;
      }
    }

    function disableChoices(msg) {
      document.querySelectorAll("#choices button").forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = 0.6;
        btn.style.cursor = "not-allowed";
      });
      document.getElementById("message").textContent = msg;
    }

    loadQuestion();
  </script>
</body>
</html>
