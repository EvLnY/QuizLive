<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz - Participant</title>
  <style>
    :root {
      --primary: #00CE7C;
      --primary-dark: #004750;
      --secondary: #8AE0B0;
      --tertiary: #C7F1D6;
      --accent: #97D1DC;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #004750;
      --text-light: #6b7280;
      --success: #00CE7C;
      --error: #ef4444;
      --animation-speed: 0.3s;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow-x: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 20px -5px rgba(0, 71, 80, 0.3);
      position: relative;
      overflow: hidden;
      z-index: 10;
    }
    
    .header::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
      animation: wave 12s infinite linear;
      z-index: 1;
    }
    
    @keyframes wave {
      0% { transform: translate(-5%, -5%) rotate(0deg); }
      100% { transform: translate(-5%, -5%) rotate(360deg); }
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      position: relative;
      z-index: 2;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .quiz-container {
      padding: 1.5rem;
      flex-grow: 1;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }
    
    .question-card {
      background: var(--card);
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform: translateY(20px);
      opacity: 0;
    }
    
    .question-card.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .question-card::after {
      content: "";
      position: absolute;
      bottom: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, transparent 50%, rgba(0, 206, 124, 0.08) 50%);
      border-radius: 0 0 20px 0;
      z-index: 1;
    }
    
    .question-number {
      position: absolute;
      top: -10px;
      left: -10px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: scale(0);
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      animation-delay: 0.3s;
      font-size: 16px;
    }
    
    @keyframes popIn {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    #question {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      line-height: 1.4;
      color: var(--text);
      position: relative;
      z-index: 2;
    }
    
    .choices-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 1.5rem;
    }
    
    .choice-btn {
      border: none;
      background: linear-gradient(to right, rgba(199, 241, 214, 0.5), rgba(138, 224, 176, 0.3));
      border-radius: 16px;
      padding: 16px;
      text-align: left;
      font-size: 1rem;
      color: var(--text);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    
    .choice-btn::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1;
    }
    
    .choice-btn.selected::before {
      opacity: 1;
    }
    
    .choice-btn span {
      position: relative;
      z-index: 2;
      transition: all 0.3s ease;
      padding-left: 10px;
    }
    
    .choice-btn.selected span {
      color: white;
      transform: translateX(5px);
    }
    
    .choice-btn .choice-indicator {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--primary);
      margin-right: 12px;
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .choice-btn.selected .choice-indicator {
      background: white;
      border-color: white;
    }
    
    .choice-btn.selected .choice-indicator::after {
      content: "";
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      position: absolute;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 1; }
      70% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(0.8); opacity: 1; }
    }
    
    .choice-btn .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.7);
      transform: scale(0);
      animation: ripple 0.6s linear;
      z-index: 0;
    }
    
    @keyframes ripple {
      to {
        transform: scale(3);
        opacity: 0;
      }
    }
    
    .submit-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 206, 124, 0.25);
      transform: translateY(0);
      opacity: 0;
      animation: fadeInUp 0.5s ease forwards;
      animation-delay: 0.6s;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .submit-btn:active {
      transform: scale(0.98);
    }
    
    .submit-btn::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shine 3s infinite;
    }
    
    @keyframes shine {
      0% { left: -100%; }
      20% { left: 100%; }
      100% { left: 100%; }
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(0, 206, 124, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spinner 0.8s linear infinite;
    }
    
    .loading-text {
      margin-top: 15px;
      color: var(--text-light);
      font-size: 0.9rem;
    }
    
    @keyframes spinner {
      to { transform: rotate(360deg); }
    }
    
    .message {
      padding: 16px;
      border-radius: 16px;
      font-weight: 600;
      text-align: center;
      animation: fadeIn 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: var(--tertiary);
      color: var(--primary-dark);
    }
    
    .message.success {
      background: linear-gradient(to right, rgba(0, 206, 124, 0.1), rgba(0, 206, 124, 0.2));
    }
    
    .message.success::before {
      content: "";
      position: absolute;
      width: 30px;
      height: 30px;
      background: var(--primary);
      border-radius: 50%;
      left: 15px;
      z-index: 1;
      opacity: 0.2;
    }
    
    .message.success::after {
      content: "âœ“";
      font-size: 1.2rem;
      color: var(--primary);
      position: absolute;
      left: 23px;
      z-index: 2;
    }
    
    .message.success span {
      margin-left: 25px;
    }
    
    .answered-tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--success);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-left: 10px;
      animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .footer {
      text-align: center;
      padding: 16px;
      color: var(--primary-dark);
      font-size: 0.9rem;
      background-color: var(--tertiary);
      position: relative;
      overflow: hidden;
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
    }
    
    .footer::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, transparent, var(--primary), transparent);
    }
    
    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }
    
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      padding: 12px 20px;
      background: var(--primary-dark);
      color: white;
      border-radius: 30px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      z-index: 100;
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      text-align: center;
      min-width: 200px;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Quiz Interactif</h1>
  </div>
  
  <div id="resetToast" class="toast">Quiz rÃ©initialisÃ© !</div>
  
  <div class="quiz-container">
    <div class="question-card" id="question-card">
      <div class="question-number" id="question-number">?</div>
      <h2 id="question">Chargement de la question...</h2>
      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Chargement du quiz...</div>
      </div>
      <div id="quiz-form"></div>
    </div>
  </div>
  
  <div class="footer">
    Participez et obtenez votre score en direct
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzhmLYw_vwrJhQW-15V1gae3DW_or6M7DoceBq49teLytqgy18yc9Q9Bse-ZSApjMsj/exec";
    let lastQuestionId = null;
    let currentQuestion = null;
    let isFirstLoad = true;
    let resetCheckInterval = null;
    let selectedChoices = [];

    function showLoading() {
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('quiz-form').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('quiz-form').style.display = 'block';
    }
    
    // Fonction d'affichage d'une notification toast temporaire
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('resetToast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // Fonction pour crÃ©er l'effet d'ondulation sur les boutons
    function createRipple(event, button) {
      const circle = document.createElement("span");
      const diameter = Math.max(button.clientWidth, button.clientHeight);
      const radius = diameter / 2;
      
      circle.style.width = circle.style.height = `${diameter}px`;
      circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
      circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
      circle.classList.add("ripple");
      
      const ripple = button.querySelector(".ripple");
      if (ripple) {
        ripple.remove();
      }
      
      button.appendChild(circle);
      
      setTimeout(() => {
        circle.remove();
      }, 600);
    }

    async function pollQuestion() {
      try {
        const res = await fetch(`${API_URL}?action=getQuestion&cacheBuster=${Date.now()}`);
        const data = await res.json();

        if (!data || data.id === "") {
          document.getElementById('question').textContent = "En attente d'une nouvelle question...";
          return;
        }

        // VÃ©rifie si l'utilisateur a dÃ©jÃ  rÃ©pondu Ã  cette question
        const alreadyAnswered = localStorage.getItem("answered_" + data.id);

        // Recharge si nouvelle question OU si verrou levÃ©
        const shouldRender = data.id !== lastQuestionId || !alreadyAnswered;
        if (!shouldRender) return;

        // DÃ©termine si c'est un nouveau quiz qui nÃ©cessite des animations
        const isNewQuestion = data.id !== lastQuestionId;
        
        lastQuestionId = data.id;
        currentQuestion = data;
        selectedChoices = [];

        // Extraire le numÃ©ro de question pour l'affichage
        let questionNumber = "";
        if (data.id) {
          const matches = data.id.match(/(\d+)$/);
          if (matches && matches[1]) {
            questionNumber = matches[1];
          }
        }
        
        document.getElementById('question-number').textContent = questionNumber ? questionNumber : "?";

        const questionElem = document.getElementById("question");
        const formContainer = document.getElementById("quiz-form");
        hideLoading();

        if (alreadyAnswered) {
          const questionText = stripMultiTag(data.question);
          questionElem.innerHTML = `${questionText} <span class="answered-tag">RÃ©pondu</span>`;
          formContainer.innerHTML = "<div class='message success'><span>Vous avez dÃ©jÃ  rÃ©pondu Ã  cette question.</span></div>";
          return;
        }

        const isMultiple = data.question.includes("::multi");
        questionElem.textContent = stripMultiTag(data.question);
        
        // Afficher "Question nÂ°X" comme titre si pas dÃ©jÃ  inclus
        if (questionNumber && !questionElem.textContent.includes(`Question nÂ°${questionNumber}`)) {
          questionElem.textContent = `Question nÂ°${questionNumber}: ${questionElem.textContent}`;
        }
        
        // Animation seulement si c'est une nouvelle question
        if (isNewQuestion) {
          document.getElementById('question-card').classList.add('shake');
          setTimeout(() => {
            document.getElementById('question-card').classList.remove('shake');
          }, 500);
        }

        formContainer.innerHTML = "";
        const choicesGrid = document.createElement("div");
        choicesGrid.className = "choices-grid";

        data.choices.forEach((choice, index) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "choice-btn";
          btn.dataset.value = choice;
          btn.innerHTML = `
            <div class="choice-indicator"></div>
            <span>${choice}</span>
          `;
          
          if (isFirstLoad || isNewQuestion) {
            btn.style.opacity = "0";
            btn.style.transform = "translateY(20px)";
          }
          
          btn.addEventListener("click", (e) => {
            if (window.navigator.vibrate) window.navigator.vibrate(50);
            createRipple(e, btn);
            
            if (isMultiple) {
              btn.classList.toggle("selected");
              if (btn.classList.contains("selected")) {
                selectedChoices.push(choice);
              } else {
                selectedChoices = selectedChoices.filter(c => c !== choice);
              }
            } else {
              document.querySelectorAll(".choice-btn").forEach(b => b.classList.remove("selected"));
              btn.classList.add("selected");
              selectedChoices = [choice];
            }
          });
          
          choicesGrid.appendChild(btn);
          
          if (isFirstLoad || isNewQuestion) {
            setTimeout(() => {
              btn.style.opacity = "1";
              btn.style.transform = "translateY(0)";
              btn.style.transition = "all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
              btn.style.transitionDelay = `${index * 0.1}s`;
            }, 100);
          }
        });
        
        formContainer.appendChild(choicesGrid);

        const submitButton = document.createElement("button");
        submitButton.type = "button";
        submitButton.className = "submit-btn";
        submitButton.textContent = isMultiple ? "Envoyer mes rÃ©ponses" : "Envoyer ma rÃ©ponse";
        
        submitButton.addEventListener("click", submitAnswers);
        formContainer.appendChild(submitButton);
        
        // AprÃ¨s le premier chargement rÃ©ussi, on change le statut
        isFirstLoad = false;
        
        // S'assurer que la carte est visible
        document.getElementById('question-card').classList.add('show');

      } catch (err) {
        console.error("Erreur lors de la rÃ©cupÃ©ration de la question :", err);
        document.getElementById('question').textContent = "Erreur de connexion...";
      }
    }

    async function submitAnswers() {
      if (!currentQuestion || selectedChoices.length === 0) {
        document.getElementById('question-card').classList.add('shake');
        setTimeout(() => {
          document.getElementById('question-card').classList.remove('shake');
        }, 500);
        return;
      }

      const submitBtn = document.querySelector(".submit-btn");
      submitBtn.disabled = true;
      submitBtn.textContent = "Envoi en cours...";
      submitBtn.style.opacity = "0.7";

      try {
        for (let answer of selectedChoices) {
          const formData = new URLSearchParams();
          formData.append("questionId", currentQuestion.id);
          formData.append("choice", answer);
          formData.append("userAgent", navigator.userAgent); // Envoi du User Agent

          await fetch(`${API_URL}?action=submitAnswer`, {
            method: "POST",
            body: formData,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          });
        }

        localStorage.setItem("answered_" + currentQuestion.id, "1");

        const formContainer = document.getElementById("quiz-form");
        formContainer.innerHTML = "<div class='message success'><span>RÃ©ponse envoyÃ©e avec succÃ¨s !</span></div>";

        const questionText = stripMultiTag(currentQuestion.question);
        
        // Maintenir le format "Question nÂ°X" si prÃ©sent dans l'affichage final
        let displayText = questionText;
        const questionNumberMatch = displayText.match(/^Question nÂ°(\d+):/);
        if (!questionNumberMatch && currentQuestion.id) {
          const idMatch = currentQuestion.id.match(/(\d+)$/);
          if (idMatch && idMatch[1]) {
            displayText = `Question nÂ°${idMatch[1]}: ${displayText}`;
          }
        }
        
        document.getElementById("question").innerHTML = `${displayText} <span class="answered-tag">RÃ©pondu</span>`;

      } catch (err) {
        console.error("Erreur lors de l'envoi de la rÃ©ponse :", err);
        document.getElementById("quiz-form").innerHTML = 
          `<div class='message' style='background: rgba(239, 68, 68, 0.1); color: var(--error);'>
            Erreur lors de l'envoi. Veuillez rÃ©essayer.
          </div>`;
      }
    }

    function stripMultiTag(questionText) {
      return questionText.replace("::multi", "").trim();
    }

    // PARTIE RÃ‰INITIALISATION - AMÃ‰LIORÃ‰E
    
    // Stocke la derniÃ¨re valeur connue du token de reset
    let lastKnownResetToken = "";

    // VÃ©rification de rÃ©initialisation par plusieurs mÃ©thodes
    function checkForReset() {
      // 1. VÃ©rifier le paramÃ¨tre d'URL pour rÃ©initialisation immÃ©diate
      const urlParams = new URLSearchParams(window.location.search);
      const resetParam = urlParams.get('reset');

      // 2. VÃ©rifier les tokens de stockage local
      const storageToken = localStorage.getItem("quizReset_token") || 
                           sessionStorage.getItem("quizReset_token") || "";

      // 3. VÃ©rifier si le timestamp de rÃ©initialisation a changÃ© (compatibilitÃ©)
      const resetTimestamp = localStorage.getItem("quizDisplay_resetTimestamp");
      const storedTimestamp = localStorage.getItem("lastKnownResetTimestamp") || "0";

      // 4. VÃ©rification directe sur le serveur
      fetch(`${API_URL}?action=checkResetStatus&cacheBuster=${Date.now()}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.resetTimestamp && data.resetTimestamp !== storedTimestamp) {
            // Reset cÃ´tÃ© serveur dÃ©tectÃ©
            localStorage.setItem("lastKnownResetTimestamp", data.resetTimestamp);
            resetAllAnswers();
            showToast("Quiz rÃ©initialisÃ© par l'administrateur!");
            pollQuestion();
            return true;
          }
        })
        .catch(err => console.error("Erreur lors de la vÃ©rification du reset:", err));

      // Un reset est dÃ©tectÃ© si:
      const isResetDetected = 
        resetParam || 
        (storageToken && storageToken !== lastKnownResetToken) ||
        (resetTimestamp && resetTimestamp !== storedTimestamp);

      if (isResetDetected) {
        console.log("RÃ©initialisation dÃ©tectÃ©e");

        // Si le reset vient de l'URL, stocker le token comme rÃ©fÃ©rence
        if (resetParam) {
          localStorage.setItem("quizReset_token", resetParam);
          sessionStorage.setItem("quizReset_token", resetParam);

          // Nettoyer l'URL pour Ã©viter des rÃ©initialisations multiples au refresh
          if (window.history && window.history.replaceState) {
            const cleanUrl = window.location.href.split('?')[0];
            window.history.replaceState({}, document.title, cleanUrl);
          }
        }

        // Mise Ã  jour des rÃ©fÃ©rences locales
        if (storageToken) {
          lastKnownResetToken = storageToken;
        }

        if (resetTimestamp) {
          localStorage.setItem("lastKnownResetTimestamp", resetTimestamp);
        }

        resetAllAnswers();

        // Notification Ã  l'utilisateur
        showToast("Quiz rÃ©initialisÃ© !");

        // RafraÃ®chir l'affichage de la question
        pollQuestion();

        return true;
      }

      return false;
    }

    // Fonction d'aide pour centraliser le code de rÃ©initialisation
    function resetAllAnswers() {
      // Effacer toutes les rÃ©ponses enregistrÃ©es
      const answeredKeys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith("answered_")) {
          answeredKeys.push(key);
        }
      }

      answeredKeys.forEach(key => localStorage.removeItem(key));
    }

    // Initialisation avec animation d'entrÃ©e uniquement au premier chargement
    document.addEventListener('DOMContentLoaded', function() {
      showLoading();
      const questionCard = document.getElementById('question-card');
      
      // VÃ©rification immÃ©diate d'une demande de rÃ©initialisation
      checkForReset();
      
      // Animation uniquement lors du premier chargement
      setTimeout(() => {
        pollQuestion();
        
        // Intervalle pour la mise Ã  jour des questions
        setInterval(pollQuestion, 2000);
        
        // Intervalle pour la vÃ©rification des rÃ©initialisations
        setInterval(checkForReset, 2000);
      }, 300);
    });
  </script>
</body>
</html>
